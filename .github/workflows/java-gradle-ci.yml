name: Java CI Standard
# TODO: gradle cache 단계 추가하기
# TODO: cd 단계에서 containerize 빼고 ci build&test로 옮길지 고민 필요
on:
  workflow_call:
    inputs:
      java-version:
        description: "JDK version"
        required: true
        type: string

      distribution:
        description: "JDK distribution"
        required: false
        default: "temurin"
        type: string

      build-command:
        description: 'Custom build command. Use "false" to run default build.'
        required: false
        default: "false"
        type: string

      test-command:
        description: 'Custom test command. Use "false" to run default test.'
        required: false
        default: "false"
        type: string

      upload-artifacts:
        description: "Upload test reports and build outputs"
        required: false
        default: true
        type: boolean

      write-application-yml:
        description: "Whether to write src/main/resources/application.yml from secret"
        required: false
        default: false
        type: boolean

    secrets:
      APPLICATION:
        description: "application.yml content"
        required: false

permissions:
  contents: read

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      java: ${{ steps.filter.outputs.java }}
    steps:
      - uses: actions/checkout@v4

      - name: Detect changes (use default filters if input empty)
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            ${{ '
            java:
              - "apps/**"
              - "src/**"
              - "build.gradle*"
              - "settings.gradle*"
              - "gradle/**"
              - ".github/workflows/**"
            ' }}

  build-test:
    name: Build & Test
    needs: changes
    if: needs.changes.outputs.java == 'true'
    runs-on: ubuntu-latest

    env:
      BUILD_COMMAND: ${{ inputs.build-command }}
      TEST_COMMAND: ${{ inputs.test-command }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java-version }}
          distribution: ${{ inputs.distribution }}
          cache: gradle

      - name: Clear Gradle caches (temporary)
        run: rm -rf ~/.gradle/caches

      - name: Network sanity check
        run: |
          set -e
          echo "=== curl repo.maven.apache.org ==="
          curl -I -L https://repo.maven.apache.org/maven2/ | sed -n '1,20p'
          echo "=== curl plugins.gradle.org ==="
          curl -I -L https://plugins.gradle.org/m2/ | sed -n '1,20p'

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4

      # Gradle 권한 부여
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # application.yml 반영
      - name: make application.yml
        if: ${{ inputs.write-application-yml }}
        shell: bash
        run: |
          cd ./src/main/resources
          touch ./application.yml
          echo "${{ secrets.APPLICATION }}" > ./application.yml

      - name: Gradle Build
        shell: bash
        run: |
          set -euo pipefail
          
          if [[ -n "${BUILD_COMMAND}" && "${BUILD_COMMAND}" != "false" ]]; then
            echo "Using Custom build command"
            eval "${BUILD_COMMAND}"
          else
            echo "Using Default build command"
            ./gradlew --no-daemon assemble
          fi

      - name: Gradle Test
        shell: bash
        run: |
          set -euo pipefail
          
          if [[ -n "${TEST_COMMAND}" && "${TEST_COMMAND}" != "false" ]]; then
            echo "Using custom TEST_COMMAND"
            eval "${TEST_COMMAND}"
          else
            echo "Using Default test command"
            ./gradlew --no-daemon test
          fi

      - name: Upload test reports
        if: ${{ inputs.upload-artifacts }}
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            **/build/reports/tests/**
            **/build/test-results/**
          if-no-files-found: ignore